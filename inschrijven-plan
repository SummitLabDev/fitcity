
# Definitief totaalplan voor GPT Codex Max (copy/paste)

## Doel

Bouw een “checkout”-achtige **/inschrijven** pagina in een bestaande **React + Vite** SPA op Cloudflare Pages, met:

1. Formulier: abonnement kiezen + startdatum + persoonsgegevens (incl. adres + geboortedatum)
2. Betaling: **€17 inschrijfkosten via Mollie iDEAL** (redirect checkout)
3. Webhook verwerking: bij payment = paid → bevestigingsmail via **Resend**
4. Voorbereiding voor later: zodra SEPA actief → automatische **Mollie subscription** aanmaken (feature flag)

## UX flow

* Vanaf huidige site komt een knop “Inschrijven” → route `/inschrijven`
* Op `/inschrijven`:

  * Stap 1: kies abonnement (uit `src/data/memberships.js`)
  * Stap 2: kies startdatum (date input)
  * Stap 3: vul gegevens:

    * Voornaam + achternaam (of “naam” als 1 veld)
    * Email
    * Telefoon
    * Geboortedatum
    * Straat
    * Huisnummer
    * Toevoeging (optioneel)
    * Postcode
    * Plaats
  * Checkbox: akkoord met voorwaarden + privacy (links)
  * CTA: “Betaal €17 inschrijfkosten”
* Na klikken:

  * Frontend POST naar `/api/start-signup-payment`
  * Response bevat `checkoutUrl`
  * Redirect naar Mollie checkout
* Na betaling:

  * Mollie redirect naar `/bedankt?signup=<id>`
  * Bedankt-pagina toont: “We verwerken je inschrijving. Je ontvangt mail.”

## Cloudflare Pages Functions toevoegen

Maak een `functions/` map aan.

### Endpoint 1: `POST /api/start-signup-payment`

**Input JSON**

```json
{
  "membershipId": "smart_deal",
  "startDate": "2026-01-10",
  "firstName": "...",
  "lastName": "...",
  "email": "...",
  "phone": "...",
  "dateOfBirth": "1998-05-12",
  "street": "...",
  "houseNumber": "...",
  "houseNumberAddition": "",
  "postalCode": "4101AB",
  "city": "Culemborg",
  "agreeTerms": true
}
```

**Validatie**

* verplichte velden aanwezig
* email basic check
* telefoon basic check
* DOB: ouder dan 12 (>=13 jaar)
* startDate mag niet in het verleden
* membershipId moet bestaan in `src/data/memberships.js`

**Acties**

* Maak `signupId` (uuid)
* Sla signup op in D1 met status `pending`
* Maak Mollie payment aan:

  * amount: 17.00 EUR
  * method: ideal (optioneel afdwingen)
  * description: `FitCity inschrijfkosten – <membership name>`
  * redirectUrl: `${APP_BASE_URL}/bedankt?signup=${signupId}`
  * webhookUrl: `${APP_BASE_URL}/api/mollie-webhook?token=${MOLLIE_WEBHOOK_TOKEN}`
  * metadata: `{ signupId }`
* Update D1: zet `mollie_payment_id`
* Return `{ checkoutUrl }`

### Endpoint 2: `POST /api/mollie-webhook`

* Valideer `token` query param == env `MOLLIE_WEBHOOK_TOKEN`
* Lees Mollie payment ID uit body (Mollie stuurt meestal `id=tr_...` form-encoded; code moet beide ondersteunen: JSON en form-url-encoded)
* Haal payment op bij Mollie API
* Zoek signup via `payment.metadata.signupId` óf via stored `mollie_payment_id`
* Als status `paid`:

  * Zet signup status `paid`
  * Verstuur Resend email naar signup.email met:

    * bevestiging €17 ontvangen
    * gekozen abonnement + prijs + looptijd
    * startdatum
    * melding dat abonnementskosten vanaf startdatum automatisch geïncasseerd worden
  * Als `ENABLE_SEPA=true` en membership is recurring:

    * Maak Mollie Customer aan (name/email)
    * Maak Subscription aan (amount monthly, interval "1 month", startDate = gekozen startDate)
    * Sla `mollie_customer_id` + `mollie_subscription_id` op
    * Zet status `subscription_created`
* Als `canceled`/`failed`:

  * Zet status overeenkomstig

**Idempotency**

* Als status al `paid` of `subscription_created`, geen dubbele email versturen.

## Database (Cloudflare D1)

Gebruik D1 met migrations in repo (bv. `migrations/0001_init.sql`).

Tabel `signups`:

* id TEXT PRIMARY KEY
* created_at TEXT
* status TEXT
* membership_id TEXT
* membership_name TEXT
* membership_price TEXT
* membership_term TEXT
* start_date TEXT
* first_name TEXT
* last_name TEXT
* email TEXT
* phone TEXT
* date_of_birth TEXT
* street TEXT
* house_number TEXT
* house_number_addition TEXT
* postal_code TEXT
* city TEXT
* mollie_payment_id TEXT
* mollie_customer_id TEXT
* mollie_subscription_id TEXT
* email_sent_at TEXT

## Email (Resend)

* Gebruik Resend API
* Env vars:

  * `RESEND_API_KEY`
  * `EMAIL_FROM` (bv. `FitCity Culemborg <noreply@summitlab.dev>`)
  * `EMAIL_REPLY_TO` (optioneel)
* Maak `src/server/email.js` of `functions/_lib/email.js` met `sendSignupConfirmation(signup)`

## Environment variables (Cloudflare Pages)

Secrets:

* `MOLLIE_API_KEY` (test/live)
* `MOLLIE_WEBHOOK_TOKEN` (random)
* `RESEND_API_KEY`
* `EMAIL_FROM`
* `APP_BASE_URL`
* `ENABLE_SEPA` ("false" initially)

## Frontend implementatie

* Voeg route `/inschrijven` toe (React Router als aanwezig; anders simple route handling in app)
* Form state + submit handler:

  * POST `/api/start-signup-payment`
  * window.location = checkoutUrl
* Voeg route `/bedankt` toe:

  * toont status (optioneel: call `/api/signup-status?signup=...` als extra)
* Houd styling consistent met huidige components

## Testing plan

* In test mode:

  * Doorloop iDEAL betaling (Mollie test)
  * Webhook moet status `paid` verwerken
  * Email moet aankomen (Resend test domain)
* SEPA subscription stap blijft achter feature flag totdat account klaar is.

## Deliverables

* Werkende PR met:

  * functions endpoints
  * D1 migration(s)
  * inschrijven + bedankt pages
  * README setup stappen (Cloudflare + env vars + Mollie webhook)
  * duidelijke comments

---

# Wat jij nu praktisch moet voorbereiden (zonder coderen)

Omdat je met Resend + domein wil werken:

1. Kies domein: **summitlab.dev** (ok)
2. In Resend: voeg domein toe en zet DNS-records in Cloudflare (SPF/DKIM/verification)
3. Kies alvast `EMAIL_FROM`, bv:

   * `FitCity Culemborg <noreply@summitlab.dev>`
